<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIN Intelligence Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-card {
            transition: transform 0.3s ease;
            height: 100%;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            font-weight: bold;
        }
        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .bin-table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        /* Sortable table styles */
        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        .sortable:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        .sort-icon {
            display: inline-block;
        }
        .sortable[data-sort-dir="asc"] .sort-icon:after {
            content: "▲";
            font-size: 0.8em;
            margin-left: 5px;
        }
        .sortable[data-sort-dir="desc"] .sort-icon:after {
            content: "▼";
            font-size: 0.8em;
            margin-left: 5px;
        }
        .dashboard-stats {
            font-size: 3rem;
            font-weight: bold;
            color: var(--bs-primary);
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="row mb-4">
            <div class="col-md-12">
                <h2 class="mb-4"><i class="bi bi-shield-lock"></i> BIN Intelligence Dashboard</h2>
                <p class="text-muted">
                    Monitor and track exploited credit card BINs with real-time verification and 3DS support detection.
                    This dashboard filters out non-major card networks (showing only Visa, MasterCard, American Express, and Discover).
                </p>
            </div>
        </div>

        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-primary text-white">
                        Total Exploited BINs
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="total-bins-stat">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-danger text-white">
                        Exploitable BINs
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="exploitable-bins-stat">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-success text-white">
                        Patched BINs
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="patched-bins-stat">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-info text-white">
                        Unique Issuers
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="issuers-stat">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Exploit Types Distribution
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="exploit-types-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="exploit-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        3DS Support Status
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="threeds-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="threeds-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- More Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Card Brands
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="brands-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="brands-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Card Countries
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countries-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="countries-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BIN Data Table -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>BIN Database</div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show-patched-bins" checked>
                            <label class="form-check-label" for="show-patched-bins">Show Patched BINs</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bin-table-container">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort-field="BIN">BIN <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="exploit_type">Exploit Type <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="patch_status">Patch Status <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="issuer">Issuer <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="brand">Brand <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="type">Type <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="country">Card Country <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="transaction_country">Trans. Country <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="threeDS1Supported">3DS v1 <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="threeDS2supported">3DS v2 <span class="sort-icon"></span></th>
                                        <th class="sortable" data-sort-field="is_verified">Verified <span class="sort-icon"></span></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bins-table-body">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="loading-spinner" id="table-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span id="pagination-info">Showing 0-0 of 0 BINs</span>
                            <nav aria-label="BIN data pagination">
                                <ul class="pagination" id="pagination-controls">
                                    <!-- Pagination will be generated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Generate More BINs
                    </div>
                    <div class="card-body">
                        <p>Generate and verify additional BINs from major card networks. BINs are verified using the Neutrino API.</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-group me-3">
                                <label for="bin-count" class="form-label">Number of BINs to generate:</label>
                                <input type="number" class="form-control" id="bin-count" value="5" min="1" max="20">
                            </div>
                            <button id="generate-bins-btn" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Generate BINs
                            </button>
                        </div>
                        <div class="mt-3" id="generation-result"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Refresh Data
                    </div>
                    <div class="card-body">
                        <p>Refresh the BIN intelligence data by scanning for new exploited BINs from fraud feeds.</p>
                        <button id="refresh-data-btn" class="btn btn-success">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Data
                        </button>
                        <div class="mt-3" id="refresh-result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Dashboard JavaScript -->
    <script>
        // Chart variables
        let exploitTypesChart, threedsChart, brandsChart, countriesChart;
        
        // Chart colors
        const chartColors = [
            '#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#7651b2', 
            '#3aa0d1', '#654321', '#ff6ec7', '#4B0082', '#FFA500'
        ];

        // Show loading spinners
        document.getElementById('exploit-spinner').style.display = 'flex';
        document.getElementById('threeds-spinner').style.display = 'flex';
        document.getElementById('brands-spinner').style.display = 'flex';
        document.getElementById('countries-spinner').style.display = 'flex';
        document.getElementById('table-spinner').style.display = 'flex';

        // Fetch statistics data and update dashboard
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                // Hide loading spinners
                document.getElementById('exploit-spinner').style.display = 'none';
                document.getElementById('threeds-spinner').style.display = 'none';
                document.getElementById('brands-spinner').style.display = 'none';
                document.getElementById('countries-spinner').style.display = 'none';

                // Update summary stats
                document.getElementById('total-bins-stat').textContent = data.total_bins;
                document.getElementById('exploitable-bins-stat').textContent = data.patch_status.Exploitable || 0;
                document.getElementById('patched-bins-stat').textContent = data.patch_status.Patched || 0;
                
                // Count unique issuers
                const uniqueIssuers = new Set();
                fetch('/api/bins')
                    .then(response => response.json())
                    .then(responseData => {
                        // Extract bins from response (may be in bins property or directly in the response)
                        const binsData = responseData.bins || responseData;
                        binsData.forEach(bin => {
                            if (bin.issuer) uniqueIssuers.add(bin.issuer);
                        });
                        document.getElementById('issuers-stat').textContent = uniqueIssuers.size;
                    })
                    .catch(error => {
                        console.error('Error fetching BIN data for issuer count:', error);
                        document.getElementById('issuers-stat').textContent = 'N/A';
                    });

                // Create Exploit Types chart
                const exploitCtx = document.getElementById('exploit-types-chart').getContext('2d');
                const exploitLabels = Object.keys(data.exploit_types);
                const exploitValues = Object.values(data.exploit_types);
                
                exploitTypesChart = new Chart(exploitCtx, {
                    type: 'doughnut',
                    data: {
                        labels: exploitLabels,
                        datasets: [{
                            data: exploitValues,
                            backgroundColor: chartColors.slice(0, exploitLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Create 3DS Support chart
                const threedsCtx = document.getElementById('threeds-chart').getContext('2d');
                const threedsLabels = Object.keys(data['3ds_support']);
                const threedsValues = Object.values(data['3ds_support']);
                
                threedsChart = new Chart(threedsCtx, {
                    type: 'pie',
                    data: {
                        labels: threedsLabels,
                        datasets: [{
                            data: threedsValues,
                            backgroundColor: ['#0F9D58', '#4285F4', '#DB4437'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Create Brands chart
                const brandsCtx = document.getElementById('brands-chart').getContext('2d');
                const brandLabels = Object.keys(data.brands);
                const brandValues = Object.values(data.brands);
                
                brandsChart = new Chart(brandsCtx, {
                    type: 'bar',
                    data: {
                        labels: brandLabels,
                        datasets: [{
                            label: 'BINs per Brand',
                            data: brandValues,
                            backgroundColor: chartColors.slice(0, brandLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Create Countries chart
                const countriesCtx = document.getElementById('countries-chart').getContext('2d');
                const countryLabels = Object.keys(data.countries);
                const countryValues = Object.values(data.countries);
                
                countriesChart = new Chart(countriesCtx, {
                    type: 'bar',
                    data: {
                        labels: countryLabels,
                        datasets: [{
                            label: 'BINs per Country',
                            data: countryValues,
                            backgroundColor: chartColors.slice(0, countryLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching statistics:', error);
                alert('Error loading dashboard statistics. Please try refreshing the page.');
            });

        // Pagination variables
        let currentPage = 1;
        const perPage = 200; // Maximum 200 BINs per page
        
        // Sorting variables
        let currentSortField = null;
        let currentSortDirection = null;
        let currentBinsData = []; // Store current page data for client-side sorting

        // Function to load BIN data with pagination
        function loadBINData(page = 1) {
            // Show loading spinner
            document.getElementById('table-spinner').style.display = 'flex';
            
            // Clear table
            const tableBody = document.getElementById('bins-table-body');
            tableBody.innerHTML = '';
            
            // Fetch paginated data
            fetch(`/api/bins?page=${page}&per_page=${perPage}`)
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    document.getElementById('table-spinner').style.display = 'none';
                    
                    // Store current page
                    currentPage = data.pagination.current_page;
                    
                    // Update pagination info
                    const startIdx = (currentPage - 1) * perPage + 1;
                    const endIdx = Math.min(startIdx + data.bins.length - 1, data.pagination.total_bins);
                    document.getElementById('pagination-info').textContent = 
                        `Showing ${startIdx}-${endIdx} of ${data.pagination.total_bins} BINs`;
                    
                    // Store current data for client-side sorting
                    currentBinsData = data.bins;
                    
                    // Generate pagination controls
                    generatePagination(data.pagination);
                    
                    // Populate table with data
                    const tableBody = document.getElementById('bins-table-body');
                    
                    data.bins.forEach(bin => {
                        const row = document.createElement('tr');
                        row.dataset.patchStatus = bin.patch_status;
                        row.dataset.brand = (bin.brand || '').toLowerCase();
                        
                        // Add class based on patch status
                        if (bin.patch_status === 'Exploitable') {
                            row.classList.add('table-danger');
                        } else if (bin.patch_status === 'Patched') {
                            row.classList.add('table-success');
                        }
                        
                        // Check if this is a cross-border transaction
                        const isCrossBorder = bin.transaction_country && bin.country && bin.transaction_country !== bin.country;
                        
                        // If exploit type is cross-border, highlight in a different color
                        if (bin.exploit_type === 'cross-border') {
                            row.classList.add('table-warning');
                        }
                        
                        row.innerHTML = `
                            <td>${bin.BIN}</td>
                            <td>${bin.exploit_type || 'Unknown'}</td>
                            <td>${bin.patch_status || 'Unknown'}</td>
                            <td>${bin.issuer || 'Unknown'}</td>
                            <td>${bin.brand || 'Unknown'}</td>
                            <td>${bin.type || 'Unknown'}</td>
                            <td>${bin.country || 'Unknown'}</td>
                            <td>${isCrossBorder ? 
                                `<span class="badge bg-warning text-dark" title="Cross-border transaction detected">${bin.transaction_country || 'Unknown'}</span>` : 
                                (bin.transaction_country || '-')}
                            </td>
                            <td>${bin.threeDS1Supported ? '✓' : '✗'}</td>
                            <td>${bin.threeDS2supported ? '✓' : '✗'}</td>
                            <td>${bin.is_verified ? '<span class="badge bg-success">Verified</span>' : '<span class="badge bg-secondary">Not Verified</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary verify-bin-btn" data-bin="${bin.BIN}" title="Verify this BIN with Neutrino API to get real-world issuer, card type, and country information">
                                    <i class="bi bi-shield-check"></i> Verify BIN
                                </button>
                                ${bin.is_verified ? `<small class="d-block text-muted mt-1">Source: ${bin.data_source}</small>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Apply filter for patched BINs
                    const showPatched = document.getElementById('show-patched-bins').checked;
                    if (!showPatched) {
                        const patchedRows = document.querySelectorAll('tr[data-patch-status="Patched"]');
                        patchedRows.forEach(row => {
                            row.style.display = 'none';
                        });
                    }
                    
                    // Filter out non-major brand cards (only show Visa, MasterCard, Amex, Discover)
                    const majorBrands = ['visa', 'mastercard', 'american express', 'amex', 'discover'];
                    document.querySelectorAll('tr[data-brand]').forEach(row => {
                        const brand = row.getAttribute('data-brand').toLowerCase();
                        // Hide any row with a brand not in our major brands list
                        if (!majorBrands.some(majorBrand => brand.includes(majorBrand))) {
                            row.style.display = 'none';
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching BIN data:', error);
                    document.getElementById('table-spinner').style.display = 'none';
                    
                    const tableBody = document.getElementById('bins-table-body');
                    const row = document.createElement('tr');
                    
                    // Check if API returned structured error response
                    if (error.response && error.response.bins) {
                        // API returned structured response with empty bins
                        row.innerHTML = `<td colspan="12" class="text-center">
                            <div class="alert alert-warning">
                                <strong>Database Error:</strong> The system encountered an error loading BIN data.
                                <br>Our developers have been notified and are working on a fix.
                                <br><small>Technical details: ${error.response.detail || 'Unknown error'}</small>
                                <br><button class="btn btn-sm btn-primary mt-2" onclick="loadBINData()">Try Again</button>
                            </div>
                        </td>`;
                    } else {
                        // Generic error (network error, etc)
                        row.innerHTML = `<td colspan="12" class="text-center">
                            <div class="alert alert-danger">
                                <strong>Connection Error:</strong> Could not load BIN data.
                                <br>Please check your network connection and try refreshing the page.
                                <br><button class="btn btn-sm btn-primary mt-2" onclick="loadBINData()">Try Again</button>
                            </div>
                        </td>`;
                    }
                    
                    tableBody.appendChild(row);
                    
                    // Reset pagination info
                    document.getElementById('pagination-info').textContent = 'Showing 0-0 of 0 BINs';
                    document.getElementById('pagination-controls').innerHTML = '';
                });
        }
        
        // Function to sort BINs data
        function sortBINData(field, direction) {
            // Show loading spinner
            document.getElementById('table-spinner').style.display = 'flex';
            
            // Remove sort indicators from all column headers
            document.querySelectorAll('.sortable').forEach(th => {
                th.removeAttribute('data-sort-dir');
            });
            
            // Add sort indicator to current column header
            const currentSortHeader = document.querySelector(`.sortable[data-sort-field="${field}"]`);
            if (currentSortHeader) {
                currentSortHeader.setAttribute('data-sort-dir', direction);
            }
            
            // Store current sort state
            currentSortField = field;
            currentSortDirection = direction;
            
            // Sort the data
            currentBinsData.sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];
                
                // Handle null or undefined values
                if (valueA === null || valueA === undefined) valueA = '';
                if (valueB === null || valueB === undefined) valueB = '';
                
                // Convert to lowercase if strings for case-insensitive comparison
                if (typeof valueA === 'string') valueA = valueA.toLowerCase();
                if (typeof valueB === 'string') valueB = valueB.toLowerCase();
                
                // For boolean values, true should come first for ascending
                if (typeof valueA === 'boolean') {
                    if (valueA === valueB) return 0;
                    
                    if (direction === 'asc') {
                        return valueA ? -1 : 1; // True comes before false
                    } else {
                        return valueA ? 1 : -1; // False comes before true
                    }
                }
                
                // For numeric values
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    return direction === 'asc' ? valueA - valueB : valueB - valueA;
                }
                
                // For strings
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Clear the table
            const tableBody = document.getElementById('bins-table-body');
            tableBody.innerHTML = '';
            
            // Populate table with sorted data
            currentBinsData.forEach(bin => {
                const row = document.createElement('tr');
                row.dataset.patchStatus = bin.patch_status;
                row.dataset.brand = (bin.brand || '').toLowerCase();
                
                // Add class based on patch status
                if (bin.patch_status === 'Exploitable') {
                    row.classList.add('table-danger');
                } else if (bin.patch_status === 'Patched') {
                    row.classList.add('table-success');
                }
                
                // Check if this is a cross-border transaction
                const isCrossBorder = bin.transaction_country && bin.country && bin.transaction_country !== bin.country;
                
                // If exploit type is cross-border, highlight in a different color
                if (bin.exploit_type === 'cross-border') {
                    row.classList.add('table-warning');
                }
                
                row.innerHTML = `
                    <td>${bin.BIN}</td>
                    <td>${bin.exploit_type || 'Unknown'}</td>
                    <td>${bin.patch_status || 'Unknown'}</td>
                    <td>${bin.issuer || 'Unknown'}</td>
                    <td>${bin.brand || 'Unknown'}</td>
                    <td>${bin.type || 'Unknown'}</td>
                    <td>${bin.country || 'Unknown'}</td>
                    <td>${isCrossBorder ? 
                        `<span class="badge bg-warning text-dark" title="Cross-border transaction detected">${bin.transaction_country || 'Unknown'}</span>` : 
                        (bin.transaction_country || '-')}
                    </td>
                    <td>${bin.threeDS1Supported ? '✓' : '✗'}</td>
                    <td>${bin.threeDS2supported ? '✓' : '✗'}</td>
                    <td>${bin.is_verified ? '<span class="badge bg-success">Verified</span>' : '<span class="badge bg-secondary">Not Verified</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary verify-bin-btn" data-bin="${bin.BIN}" title="Verify this BIN with Neutrino API to get real-world issuer, card type, and country information">
                            <i class="bi bi-shield-check"></i> Verify BIN
                        </button>
                        ${bin.is_verified ? `<small class="d-block text-muted mt-1">Source: ${bin.data_source}</small>` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Apply filter for patched BINs
            const showPatched = document.getElementById('show-patched-bins').checked;
            if (!showPatched) {
                const patchedRows = document.querySelectorAll('tr[data-patch-status="Patched"]');
                patchedRows.forEach(row => {
                    row.style.display = 'none';
                });
            }
            
            // Filter out non-major brand cards (only show Visa, MasterCard, Amex, Discover)
            const majorBrands = ['visa', 'mastercard', 'american express', 'amex', 'discover'];
            document.querySelectorAll('tr[data-brand]').forEach(row => {
                const brand = row.getAttribute('data-brand').toLowerCase();
                // Hide any row with a brand not in our major brands list
                if (!majorBrands.some(majorBrand => brand.includes(majorBrand))) {
                    row.style.display = 'none';
                }
            });
            
            // Hide loading spinner
            document.getElementById('table-spinner').style.display = 'none';
        }
        
        // Function to generate pagination controls
        function generatePagination(pagination) {
            const paginationContainer = document.getElementById('pagination-controls');
            paginationContainer.innerHTML = '';
            
            // Don't show pagination if there's only one page
            if (pagination.total_pages <= 1) return;
            
            // Previous page button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${pagination.current_page === 1 ? 'disabled' : ''}`;
            
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.setAttribute('aria-label', 'Previous');
            prevLink.innerHTML = '<span aria-hidden="true">&laquo;</span>';
            
            if (pagination.current_page > 1) {
                prevLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadBINData(pagination.current_page - 1);
                });
            }
            
            prevLi.appendChild(prevLink);
            paginationContainer.appendChild(prevLi);
            
            // Page number buttons
            const maxVisiblePages = 5;
            let startPage = Math.max(1, pagination.current_page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxVisiblePages - 1);
            
            // Adjust startPage if we are near the end
            if (endPage === pagination.total_pages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
                
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (i !== pagination.current_page) {
                        loadBINData(i);
                    }
                });
                
                pageLi.appendChild(pageLink);
                paginationContainer.appendChild(pageLi);
            }
            
            // Next page button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}`;
            
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.setAttribute('aria-label', 'Next');
            nextLink.innerHTML = '<span aria-hidden="true">&raquo;</span>';
            
            if (pagination.current_page < pagination.total_pages) {
                nextLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadBINData(pagination.current_page + 1);
                });
            }
            
            nextLi.appendChild(nextLink);
            paginationContainer.appendChild(nextLi);
        }

        // Initial load of BIN data
        loadBINData();

        // Set up sorting when clicking on column headers
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const field = this.getAttribute('data-sort-field');
                let direction = 'asc';
                
                // Toggle sort direction if already sorting by this field
                if (field === currentSortField) {
                    direction = currentSortDirection === 'asc' ? 'desc' : 'asc';
                }
                
                // Sort the data
                sortBINData(field, direction);
            });
        });

        // Toggle patched bins in table
        document.getElementById('show-patched-bins').addEventListener('change', function() {
            const patchedRows = document.querySelectorAll('tr[data-patch-status="Patched"]');
            patchedRows.forEach(row => {
                row.style.display = this.checked ? '' : 'none';
            });
        });

        // Verify BIN button click handler
        document.addEventListener('click', function(e) {
            if (e.target.closest('.verify-bin-btn')) {
                const button = e.target.closest('.verify-bin-btn');
                const bin = button.getAttribute('data-bin');
                
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';
                
                fetch(`/verify-bin/${bin}`)
                    .then(response => response.json())
                    .then(data => {
                        // Re-enable button
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-shield-check"></i> Verify BIN';
                        
                        if (data.error) {
                            alert(`Error verifying BIN: ${data.error}`);
                        } else {
                            // Replace the current row with updated data
                            const row = button.closest('tr');
                            
                            // Check if this is a cross-border transaction
                            const isCrossBorder = data.transaction_country && data.country && data.transaction_country !== data.country;
                            
                            // Update row classes based on new data
                            row.className = ''; // Clear existing classes
                            
                            if (data.patch_status === 'Exploitable') {
                                row.classList.add('table-danger');
                            } else if (data.patch_status === 'Patched') {
                                row.classList.add('table-success');
                            }
                            
                            if (data.exploit_type === 'cross-border') {
                                row.classList.add('table-warning');
                            }
                            
                            // Update row data attributes
                            row.dataset.patchStatus = data.patch_status;
                            row.dataset.brand = (data.brand || '').toLowerCase();
                            
                            // Update row HTML
                            row.innerHTML = `
                                <td>${data.BIN}</td>
                                <td>${data.exploit_type || 'Unknown'}</td>
                                <td>${data.patch_status || 'Unknown'}</td>
                                <td>${data.issuer || 'Unknown'}</td>
                                <td>${data.brand || 'Unknown'}</td>
                                <td>${data.type || 'Unknown'}</td>
                                <td>${data.country || 'Unknown'}</td>
                                <td>${isCrossBorder ? 
                                    `<span class="badge bg-warning text-dark" title="Cross-border transaction detected">${data.transaction_country || 'Unknown'}</span>` : 
                                    (data.transaction_country || '-')}
                                </td>
                                <td>${data.threeDS1Supported ? '✓' : '✗'}</td>
                                <td>${data.threeDS2supported ? '✓' : '✗'}</td>
                                <td><span class="badge bg-success">Verified</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary verify-bin-btn" data-bin="${data.BIN}" title="Verify this BIN with Neutrino API to get real-world issuer, card type, and country information">
                                        <i class="bi bi-shield-check"></i> Verify BIN
                                    </button>
                                    <small class="d-block text-muted mt-1">Source: ${data.data_source}</small>
                                </td>
                            `;
                            
                            // Show success message
                            alert(`BIN ${bin} verified successfully: ${data.issuer} ${data.brand} ${data.type} card from ${data.country}`);
                            
                            // Filter again if needed (for patched/non-major brands)
                            const showPatched = document.getElementById('show-patched-bins').checked;
                            if (!showPatched && data.patch_status === 'Patched') {
                                row.style.display = 'none';
                            }
                            
                            const majorBrands = ['visa', 'mastercard', 'american express', 'amex', 'discover'];
                            const brand = (data.brand || '').toLowerCase();
                            if (!majorBrands.some(majorBrand => brand.includes(majorBrand))) {
                                row.style.display = 'none';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-shield-check"></i> Verify BIN';
                        alert('Error verifying BIN. Please try again.');
                    });
            }
        });

        // Generate BINs button click handler
        document.getElementById('generate-bins-btn').addEventListener('click', function() {
            const count = document.getElementById('bin-count').value;
            const generateResult = document.getElementById('generation-result');
            
            // Validate input
            if (count < 1 || count > 20) {
                generateResult.innerHTML = '<div class="alert alert-danger">Please enter a number between 1 and 20.</div>';
                return;
            }
            
            // Disable button during API call
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            
            generateResult.innerHTML = '<div class="alert alert-info">Generating and verifying BINs... This may take a moment.</div>';
            
            fetch(`/generate-bins?count=${count}`)
                .then(response => response.json())
                .then(data => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-plus-circle"></i> Generate BINs';
                    
                    if (data.status === 'error' || data.error || data.message) {
                        generateResult.innerHTML = `<div class="alert alert-danger">${data.error || data.message || 'Unknown error occurred'}</div>`;
                    } else {
                        // Show success message
                        generateResult.innerHTML = `
                            <div class="alert alert-success">
                                <strong>Success!</strong> Generated ${data.new_bins || 0} new BINs.
                                <p>Total BINs in the system: ${data.total_bins || 0}</p>
                            </div>
                        `;
                        
                        // Reload BIN data to show new BINs
                        loadBINData(1);
                        
                        // Update charts
                        fetch('/api/stats')
                            .then(response => response.json())
                            .then(statsData => {
                                // Update summary stats
                                document.getElementById('total-bins-stat').textContent = statsData.total_bins;
                                document.getElementById('exploitable-bins-stat').textContent = statsData.patch_status.Exploitable || 0;
                                document.getElementById('patched-bins-stat').textContent = statsData.patch_status.Patched || 0;
                                
                                // Update charts
                                updateCharts(statsData);
                            })
                            .catch(error => {
                                console.error('Error updating stats after BIN generation:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-plus-circle"></i> Generate BINs';
                    generateResult.innerHTML = '<div class="alert alert-danger">Error generating BINs. Please try again.</div>';
                });
        });

        // Refresh Data button click handler
        document.getElementById('refresh-data-btn').addEventListener('click', function() {
            const refreshResult = document.getElementById('refresh-result');
            
            // Disable button during API call
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
            
            refreshResult.innerHTML = '<div class="alert alert-info">Refreshing BIN intelligence data... This may take a moment.</div>';
            
            fetch('/refresh')
                .then(response => response.json())
                .then(data => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
                    
                    if (data.status === 'error' || data.error) {
                        refreshResult.innerHTML = `<div class="alert alert-danger">${data.error || 'Unknown error occurred'}</div>`;
                    } else {
                        // Show success message
                        refreshResult.innerHTML = `
                            <div class="alert alert-success">
                                <strong>Success!</strong> Refreshed BIN intelligence data.
                                <p>Total BINs in the system: ${data.bins_count || 0}</p>
                                ${data.bins_found ? `<p>New BINs found: ${data.bins_found}</p>` : ''}
                                ${data.bins_classified ? `<p>BINs classified: ${data.bins_classified}</p>` : ''}
                            </div>
                        `;
                        
                        // Reload BIN data to show new BINs
                        loadBINData(1);
                        
                        // Update charts
                        fetch('/api/stats')
                            .then(response => response.json())
                            .then(statsData => {
                                // Update summary stats
                                document.getElementById('total-bins-stat').textContent = statsData.total_bins;
                                document.getElementById('exploitable-bins-stat').textContent = statsData.patch_status.Exploitable || 0;
                                document.getElementById('patched-bins-stat').textContent = statsData.patch_status.Patched || 0;
                                
                                // Update charts
                                updateCharts(statsData);
                            })
                            .catch(error => {
                                console.error('Error updating stats after data refresh:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
                    refreshResult.innerHTML = '<div class="alert alert-danger">Error refreshing data. Please try again.</div>';
                });
        });

        // Function to update charts with new data
        function updateCharts(data) {
            // Update Exploit Types chart
            const exploitLabels = Object.keys(data.exploit_types);
            const exploitValues = Object.values(data.exploit_types);
            
            exploitTypesChart.data.labels = exploitLabels;
            exploitTypesChart.data.datasets[0].data = exploitValues;
            exploitTypesChart.update();
            
            // Update 3DS Support chart
            const threedsLabels = Object.keys(data['3ds_support']);
            const threedsValues = Object.values(data['3ds_support']);
            
            threedsChart.data.labels = threedsLabels;
            threedsChart.data.datasets[0].data = threedsValues;
            threedsChart.update();
            
            // Update Brands chart
            const brandLabels = Object.keys(data.brands);
            const brandValues = Object.values(data.brands);
            
            brandsChart.data.labels = brandLabels;
            brandsChart.data.datasets[0].data = brandValues;
            brandsChart.update();
            
            // Update Countries chart
            const countryLabels = Object.keys(data.countries);
            const countryValues = Object.values(data.countries);
            
            countriesChart.data.labels = countryLabels;
            countriesChart.data.datasets[0].data = countryValues;
            countriesChart.update();
        }
    </script>
</body>
</html>