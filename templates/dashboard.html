<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIN Intelligence Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-card {
            transition: transform 0.3s ease;
            height: 100%;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            font-weight: bold;
        }
        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .bin-table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .dashboard-stats {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            height: 250px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-lock-fill me-2"></i>
                BIN Intelligence System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#bins-table">BIN Data</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="refresh-data">Refresh Data</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Top Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-primary text-white">
                        Total Exploited BINs
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="total-bins-stat">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-danger text-white">
                        Exploitable BINs
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="exploitable-bins-stat">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-success text-white">
                        Patched BINs
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="patched-bins-stat">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-info text-white">
                        Unique Issuers
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="dashboard-stats" id="unique-issuers-stat">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Exploit Types Distribution
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="exploit-types-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="exploit-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        3DS Support Status
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="threeds-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="threeds-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- More Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Top Card Brands
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="brands-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="brands-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        Top Countries
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countries-chart"></canvas>
                        </div>
                        <div class="loading-spinner" id="countries-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row mb-4" id="bins-table">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Exploited BINs Data</span>
                        <div class="d-flex align-items-center">
                            <button id="generate-more-bins" class="btn btn-primary me-3">Generate 100 More BINs</button>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show-patched-bins" checked>
                                <label class="form-check-label" for="show-patched-bins">Show Patched BINs</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bin-table-container">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>BIN</th>
                                        <th>Exploit Type</th>
                                        <th>Patch Status</th>
                                        <th>Issuer</th>
                                        <th>Brand</th>
                                        <th>Type</th>
                                        <th>Card Country</th>
                                        <th>Trans. Country</th>
                                        <th>3DS v1</th>
                                        <th>3DS v2</th>
                                        <th>Verified</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bins-table-body">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="loading-spinner" id="table-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div id="pagination-info" class="text-muted">
                                Showing 0-0 of 0 BINs
                            </div>
                            <nav aria-label="BIN data pagination">
                                <ul class="pagination" id="pagination-controls">
                                    <!-- Pagination will be generated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Chart colors
        const chartColors = [
            '#4dc9f6', '#f67019', '#f53794', '#537bc4', '#acc236',
            '#166a8f', '#00a950', '#58595b', '#8549ba', '#e6194b'
        ];

        // Initialize empty charts
        let exploitTypesChart, threedsChart, brandsChart, countriesChart;

        // Show loading spinners
        document.getElementById('exploit-spinner').style.display = 'flex';
        document.getElementById('threeds-spinner').style.display = 'flex';
        document.getElementById('brands-spinner').style.display = 'flex';
        document.getElementById('countries-spinner').style.display = 'flex';
        document.getElementById('table-spinner').style.display = 'flex';

        // Fetch statistics data and update dashboard
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                // Hide loading spinners
                document.getElementById('exploit-spinner').style.display = 'none';
                document.getElementById('threeds-spinner').style.display = 'none';
                document.getElementById('brands-spinner').style.display = 'none';
                document.getElementById('countries-spinner').style.display = 'none';

                // Update summary stats
                document.getElementById('total-bins-stat').textContent = data.total_bins;
                document.getElementById('exploitable-bins-stat').textContent = data.patch_status.Exploitable || 0;
                document.getElementById('patched-bins-stat').textContent = data.patch_status.Patched || 0;
                
                // Count unique issuers
                const uniqueIssuers = new Set();
                fetch('/api/bins')
                    .then(response => response.json())
                    .then(responseData => {
                        // Extract bins from response (may be in bins property or directly in the response)
                        const binsData = responseData.bins || responseData;
                        binsData.forEach(bin => {
                            if (bin.issuer) uniqueIssuers.add(bin.issuer);
                        });
                        document.getElementById('unique-issuers-stat').textContent = uniqueIssuers.size;
                    });

                // Create Exploit Types chart
                const exploitTypesCtx = document.getElementById('exploit-types-chart').getContext('2d');
                const exploitLabels = Object.keys(data.exploit_types);
                const exploitValues = Object.values(data.exploit_types);
                
                exploitTypesChart = new Chart(exploitTypesCtx, {
                    type: 'pie',
                    data: {
                        labels: exploitLabels,
                        datasets: [{
                            data: exploitValues,
                            backgroundColor: chartColors.slice(0, exploitLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });

                // Create 3DS Support chart
                const threedsCtx = document.getElementById('threeds-chart').getContext('2d');
                const threedsLabels = Object.keys(data['3ds_support']);
                const threedsValues = Object.values(data['3ds_support']);
                
                threedsChart = new Chart(threedsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: threedsLabels,
                        datasets: [{
                            data: threedsValues,
                            backgroundColor: [
                                '#00a950',  // 3DS v1 - Green 
                                '#4dc9f6',  // 3DS v2 - Blue
                                '#f67019'   // No 3DS - Orange
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });

                // Create Brands chart
                const brandsCtx = document.getElementById('brands-chart').getContext('2d');
                const brandLabels = Object.keys(data.brands);
                const brandValues = Object.values(data.brands);
                
                brandsChart = new Chart(brandsCtx, {
                    type: 'bar',
                    data: {
                        labels: brandLabels,
                        datasets: [{
                            label: 'BINs per Brand',
                            data: brandValues,
                            backgroundColor: chartColors.slice(0, brandLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Create Countries chart
                const countriesCtx = document.getElementById('countries-chart').getContext('2d');
                const countryLabels = Object.keys(data.countries);
                const countryValues = Object.values(data.countries);
                
                countriesChart = new Chart(countriesCtx, {
                    type: 'bar',
                    data: {
                        labels: countryLabels,
                        datasets: [{
                            label: 'BINs per Country',
                            data: countryValues,
                            backgroundColor: chartColors.slice(0, countryLabels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching statistics:', error);
                alert('Error loading dashboard statistics. Please try refreshing the page.');
            });

        // Pagination variables
        let currentPage = 1;
        const perPage = 200; // Maximum 200 BINs per page
        
        // Function to load BIN data with pagination
        function loadBINData(page = 1) {
            // Show loading spinner
            document.getElementById('table-spinner').style.display = 'flex';
            
            // Clear table
            const tableBody = document.getElementById('bins-table-body');
            tableBody.innerHTML = '';
            
            // Fetch paginated data
            fetch(`/api/bins?page=${page}&per_page=${perPage}`)
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    document.getElementById('table-spinner').style.display = 'none';
                    
                    // Store current page
                    currentPage = data.pagination.current_page;
                    
                    // Update pagination info
                    const startIdx = (currentPage - 1) * perPage + 1;
                    const endIdx = Math.min(startIdx + data.bins.length - 1, data.pagination.total_bins);
                    document.getElementById('pagination-info').textContent = 
                        `Showing ${startIdx}-${endIdx} of ${data.pagination.total_bins} BINs`;
                    
                    // Generate pagination controls
                    generatePagination(data.pagination);
                    
                    // Populate table
                    data.bins.forEach(bin => {
                        const row = document.createElement('tr');
                        row.dataset.patchStatus = bin.patch_status;
                        
                        // Add class based on patch status
                        if (bin.patch_status === 'Exploitable') {
                            row.classList.add('table-danger');
                        } else if (bin.patch_status === 'Patched') {
                            row.classList.add('table-success');
                        }
                        
                        // Check if this is a cross-border transaction
                        const isCrossBorder = bin.transaction_country && bin.country && bin.transaction_country !== bin.country;
                        
                        // If exploit type is cross-border, highlight in a different color
                        if (bin.exploit_type === 'cross-border') {
                            row.classList.add('table-warning');
                        }
                        
                        row.innerHTML = `
                            <td>${bin.BIN}</td>
                            <td>${bin.exploit_type || 'Unknown'}</td>
                            <td>${bin.patch_status || 'Unknown'}</td>
                            <td>${bin.issuer || 'Unknown'}</td>
                            <td>${bin.brand || 'Unknown'}</td>
                            <td>${bin.type || 'Unknown'}</td>
                            <td>${bin.country || 'Unknown'}</td>
                            <td>${isCrossBorder ? 
                                `<span class="badge bg-warning text-dark" title="Cross-border transaction detected">${bin.transaction_country || 'Unknown'}</span>` : 
                                (bin.transaction_country || '-')}
                            </td>
                            <td>${bin.threeDS1Supported ? '✓' : '✗'}</td>
                            <td>${bin.threeDS2supported ? '✓' : '✗'}</td>
                            <td>${bin.is_verified ? '<span class="badge bg-success">Verified</span>' : '<span class="badge bg-secondary">Not Verified</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary verify-bin-btn" data-bin="${bin.BIN}" title="Verify this BIN with Neutrino API to get real-world issuer, card type, and country information">
                                    <i class="bi bi-shield-check"></i> Verify BIN
                                </button>
                                ${bin.is_verified ? `<small class="d-block text-muted mt-1">Source: ${bin.data_source}</small>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Apply filter for patched BINs
                    const showPatched = document.getElementById('show-patched-bins').checked;
                    if (!showPatched) {
                        const patchedRows = document.querySelectorAll('tr[data-patch-status="Patched"]');
                        patchedRows.forEach(row => {
                            row.style.display = 'none';
                        });
                    }
                    
                    // Filter out non-major brand cards (only show Visa, MasterCard, Amex, Discover)
                    const majorBrands = ['visa', 'mastercard', 'american express', 'amex', 'discover'];
                    document.querySelectorAll('tr[data-brand]').forEach(row => {
                        const brand = row.getAttribute('data-brand').toLowerCase();
                        // Hide any row with a brand not in our major brands list
                        if (!majorBrands.some(majorBrand => brand.includes(majorBrand))) {
                            row.style.display = 'none';
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching BIN data:', error);
                    document.getElementById('table-spinner').style.display = 'none';
                    
                    const tableBody = document.getElementById('bins-table-body');
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="9" class="text-center">Error loading BIN data. Please try refreshing the page.</td>`;
                    tableBody.appendChild(row);
                    
                    // Reset pagination info
                    document.getElementById('pagination-info').textContent = 'Showing 0-0 of 0 BINs';
                    document.getElementById('pagination-controls').innerHTML = '';
                });
        }
        
        // Function to generate pagination controls
        function generatePagination(pagination) {
            const paginationContainer = document.getElementById('pagination-controls');
            paginationContainer.innerHTML = '';
            
            // Only show pagination if we have more than one page
            if (pagination.total_pages <= 1) {
                return;
            }
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${pagination.current_page === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Previous';
            prevLink.setAttribute('aria-label', 'Previous');
            if (pagination.current_page > 1) {
                prevLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadBINData(pagination.current_page - 1);
                });
            }
            prevLi.appendChild(prevLink);
            paginationContainer.appendChild(prevLi);
            
            // Page numbers
            const maxPages = 5; // Maximum number of page links to show
            const startPage = Math.max(1, pagination.current_page - Math.floor(maxPages / 2));
            const endPage = Math.min(pagination.total_pages, startPage + maxPages - 1);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i.toString();
                if (i !== pagination.current_page) {
                    pageLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadBINData(i);
                    });
                }
                pageLi.appendChild(pageLink);
                paginationContainer.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${pagination.current_page === pagination.total_pages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Next';
            nextLink.setAttribute('aria-label', 'Next');
            if (pagination.current_page < pagination.total_pages) {
                nextLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadBINData(pagination.current_page + 1);
                });
            }
            nextLi.appendChild(nextLink);
            paginationContainer.appendChild(nextLi);
        }
        
        // Initial load of BIN data
        loadBINData();

        // Toggle patched bins in table
        document.getElementById('show-patched-bins').addEventListener('change', function() {
            const patchedRows = document.querySelectorAll('tr[data-patch-status="Patched"]');
            patchedRows.forEach(row => {
                row.style.display = this.checked ? '' : 'none';
            });
        });
        
        // Generate more BINs button
        document.getElementById('generate-more-bins').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Disable button to prevent multiple clicks
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            
            // Show loading spinner for table
            document.getElementById('table-spinner').style.display = 'flex';
            
            // Counter variables for batched generation
            let batchSize = 20;
            let totalBatches = 5; // 5 batches of 20 = 100 BINs
            let completedBatches = 0;
            let totalCreated = 0;
            let totalUpdated = 0;
            let currentTotal = 0;
            let hadError = false;
            
            const button = this;
            
            // Function to generate BINs in batches
            function generateBatch() {
                if (completedBatches >= totalBatches || hadError) {
                    // All batches processed or error occurred
                    finishOperation();
                    return;
                }
                
                // Update button text to show progress
                button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating... (${completedBatches * batchSize}/${totalBatches * batchSize})`;
                
                // Call generate endpoint for a single batch
                fetch(`/generate-bins?count=${batchSize}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Increment counters
                            completedBatches++;
                            totalCreated += data.new_bins;
                            totalUpdated += data.updated_bins;
                            currentTotal = data.total_bins;
                            
                            // Continue with next batch
                            generateBatch();
                        } else {
                            // Error occurred
                            console.error('Error generating BINs:', data.message);
                            hadError = true;
                            alert(`Error generating BINs: ${data.message || 'Unknown error'}`);
                            finishOperation();
                        }
                    })
                    .catch(error => {
                        // Error occurred
                        console.error('Error generating BINs:', error);
                        hadError = true;
                        alert('Error generating BINs. Please try again.');
                        finishOperation();
                    });
            }
            
            // Function to finish the operation
            function finishOperation() {
                // Enable button
                button.disabled = false;
                button.textContent = 'Generate 100 More BINs';
                
                if (!hadError) {
                    // Show success message
                    alert(`Successfully generated ${totalCreated} new BINs, updated ${totalUpdated} existing. Total: ${currentTotal} BINs.`);
                }
                
                // Reload current page of BIN data to show new BINs
                loadBINData(currentPage);
                
                // Reload stats to update dashboard
                fetch('/api/stats')
                    .then(response => response.json())
                    .then(statsData => {
                        // Update summary stats
                        document.getElementById('total-bins-stat').textContent = statsData.total_bins;
                        document.getElementById('exploitable-bins-stat').textContent = statsData.patch_status.Exploitable || 0;
                        document.getElementById('patched-bins-stat').textContent = statsData.patch_status.Patched || 0;
                        
                        // Update charts
                        updateCharts(statsData);
                    });
                
                // Hide loading spinner
                document.getElementById('table-spinner').style.display = 'none';
            }
            
            // Start generating batches
            generateBatch();
        });
        
        // Function to update charts with new data
        function updateCharts(data) {
            // Update Exploit Types chart
            const exploitLabels = Object.keys(data.exploit_types);
            const exploitValues = Object.values(data.exploit_types);
            
            exploitTypesChart.data.labels = exploitLabels;
            exploitTypesChart.data.datasets[0].data = exploitValues;
            exploitTypesChart.update();
            
            // Update 3DS Support chart
            const threedsLabels = Object.keys(data['3ds_support']);
            const threedsValues = Object.values(data['3ds_support']);
            
            threedsChart.data.labels = threedsLabels;
            threedsChart.data.datasets[0].data = threedsValues;
            threedsChart.update();
            
            // Update Brands chart
            const brandLabels = Object.keys(data.brands);
            const brandValues = Object.values(data.brands);
            
            brandsChart.data.labels = brandLabels;
            brandsChart.data.datasets[0].data = brandValues;
            brandsChart.update();
            
            // Update Countries chart
            const countryLabels = Object.keys(data.countries);
            const countryValues = Object.values(data.countries);
            
            countriesChart.data.labels = countryLabels;
            countriesChart.data.datasets[0].data = countryValues;
            countriesChart.update();
        }

        // Event listener for verify bin buttons - use event delegation
        document.addEventListener('click', function(e) {
            // Check if the clicked element has the verify-bin-btn class
            if (e.target && e.target.classList.contains('verify-bin-btn')) {
                e.preventDefault();
                
                // Get the BIN from the data attribute
                const binCode = e.target.getAttribute('data-bin');
                if (!binCode) return;
                
                // Disable button and show loading state
                e.target.disabled = true;
                e.target.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';
                
                // Call the verify endpoint
                fetch(`/verify-bin/${binCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Show detailed success message
                            const binData = data.data;
                            alert(`BIN ${binCode} verified successfully with Neutrino API.\n\n` +
                                  `Card Type: ${binData.type}\n` + 
                                  `Brand: ${binData.brand}\n` +
                                  `Issuer: ${binData.issuer}\n` + 
                                  `Country: ${binData.country}\n` +
                                  `3DS Support: ${binData.threeDS1Supported || binData.threeDS2supported ? 'Yes' : 'No'}`);
                            
                            // Reload current page of BIN data to show updated verification status
                            loadBINData(currentPage);
                        } else {
                            // Show error message
                            alert(`Error verifying BIN ${binCode}: ${data.message || 'Unknown error'}`);
                            
                            // Re-enable the button
                            e.target.disabled = false;
                            e.target.textContent = 'Verify with Neutrino';
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying BIN:', error);
                        
                        // Show error message
                        alert(`Error verifying BIN ${binCode}. Please try again.`);
                        
                        // Re-enable the button
                        e.target.disabled = false;
                        e.target.textContent = 'Verify with Neutrino';
                    });
            }
        });

        // Refresh data
        document.getElementById('refresh-data').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show confirmation dialog
            if (confirm('This will refresh all BIN data by running the BIN Intelligence System. This may take some time. Continue?')) {
                // Show loading spinners
                document.getElementById('exploit-spinner').style.display = 'flex';
                document.getElementById('threeds-spinner').style.display = 'flex';
                document.getElementById('brands-spinner').style.display = 'flex';
                document.getElementById('countries-spinner').style.display = 'flex';
                document.getElementById('table-spinner').style.display = 'flex';
                
                // Clear table
                document.getElementById('bins-table-body').innerHTML = '';
                
                // Destroy existing charts
                exploitTypesChart.destroy();
                threedsChart.destroy();
                brandsChart.destroy();
                countriesChart.destroy();
                
                // Refresh data
                fetch('/refresh')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Data refreshed successfully! Found ${data.bins_count} BINs.`);
                            // Reload page to display new data
                            window.location.reload();
                        } else {
                            alert('Error refreshing data. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing data:', error);
                        alert('Error refreshing data. Please try again.');
                    });
            }
        });
    </script>
</body>
</html>